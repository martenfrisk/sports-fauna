{"ast":null,"code":"import { query as q } from 'faunadb';\nimport { guestClient } from '@/utils/fauna-client';\nimport { setAuthCookie } from '@/utils/auth-cookies';\nexport default async function signup(req, res) {\n  const {\n    email,\n    username,\n    favTeam,\n    password\n  } = req.body;\n\n  if (!email || !password) {\n    return res.status(400).send('Email and password not provided');\n  }\n\n  try {\n    const existingEmail = await guestClient.query(q.Exists(q.Match(q.Index('user_by_email'), q.Casefold(email))));\n\n    if (existingEmail) {\n      return res.status(400).send(`Email ${email} already exists`);\n    }\n\n    const user = await guestClient.query(q.Create(q.Collection('User'), {\n      credentials: {\n        password\n      },\n      data: {\n        email,\n        username,\n        favTeam\n      }\n    }));\n\n    if (!user.ref) {\n      return res.status(404).send('User ref is missing');\n    }\n\n    const auth = await guestClient.query(q.Login(user.ref, {\n      password\n    }));\n\n    if (!auth.secret) {\n      return res.status(404).send('Auth secret is missing');\n    }\n\n    setAuthCookie(res, auth.secret);\n    res.status(200).end();\n  } catch (error) {\n    console.error(error);\n    res.status(error.requestResult.statusCode).send(error.message);\n  }\n}","map":{"version":3,"sources":["/Users/marten.frisk/nextfauna/pages/api/signup.js"],"names":["query","q","guestClient","setAuthCookie","signup","req","res","email","username","favTeam","password","body","status","send","existingEmail","Exists","Match","Index","Casefold","user","Create","Collection","credentials","data","ref","auth","Login","secret","end","error","console","requestResult","statusCode","message"],"mappings":"AAAA,SAASA,KAAK,IAAIC,CAAlB,QAA2B,SAA3B;AACA,SAASC,WAAT,QAA4B,sBAA5B;AACA,SAASC,aAAT,QAA8B,sBAA9B;AAEA,eAAe,eAAeC,MAAf,CAAsBC,GAAtB,EAA2BC,GAA3B,EAAgC;AAC9C,QAAM;AAAEC,IAAAA,KAAF;AAASC,IAAAA,QAAT;AAAmBC,IAAAA,OAAnB;AAA4BC,IAAAA;AAA5B,MAAyCL,GAAG,CAACM,IAAnD;;AAEA,MAAI,CAACJ,KAAD,IAAU,CAACG,QAAf,EAAyB;AACxB,WAAOJ,GAAG,CAACM,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,iCAArB,CAAP;AACA;;AAED,MAAI;AACH,UAAMC,aAAa,GAAG,MAAMZ,WAAW,CAACF,KAAZ,CAC3BC,CAAC,CAACc,MAAF,CAASd,CAAC,CAACe,KAAF,CAAQf,CAAC,CAACgB,KAAF,CAAQ,eAAR,CAAR,EAAkChB,CAAC,CAACiB,QAAF,CAAWX,KAAX,CAAlC,CAAT,CAD2B,CAA5B;;AAIA,QAAIO,aAAJ,EAAmB;AAClB,aAAOR,GAAG,CAACM,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAsB,SAAQN,KAAM,iBAApC,CAAP;AACA;;AAED,UAAMY,IAAI,GAAG,MAAMjB,WAAW,CAACF,KAAZ,CAClBC,CAAC,CAACmB,MAAF,CAASnB,CAAC,CAACoB,UAAF,CAAa,MAAb,CAAT,EAA+B;AAC9BC,MAAAA,WAAW,EAAE;AAAEZ,QAAAA;AAAF,OADiB;AAE9Ba,MAAAA,IAAI,EAAE;AAAEhB,QAAAA,KAAF;AAASC,QAAAA,QAAT;AAAmBC,QAAAA;AAAnB;AAFwB,KAA/B,CADkB,CAAnB;;AAOA,QAAI,CAACU,IAAI,CAACK,GAAV,EAAe;AACd,aAAOlB,GAAG,CAACM,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,qBAArB,CAAP;AACA;;AAED,UAAMY,IAAI,GAAG,MAAMvB,WAAW,CAACF,KAAZ,CAClBC,CAAC,CAACyB,KAAF,CAAQP,IAAI,CAACK,GAAb,EAAkB;AACjBd,MAAAA;AADiB,KAAlB,CADkB,CAAnB;;AAMA,QAAI,CAACe,IAAI,CAACE,MAAV,EAAkB;AACjB,aAAOrB,GAAG,CAACM,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,wBAArB,CAAP;AACA;;AAEDV,IAAAA,aAAa,CAACG,GAAD,EAAMmB,IAAI,CAACE,MAAX,CAAb;AAEArB,IAAAA,GAAG,CAACM,MAAJ,CAAW,GAAX,EAAgBgB,GAAhB;AACA,GAjCD,CAiCE,OAAOC,KAAP,EAAc;AACfC,IAAAA,OAAO,CAACD,KAAR,CAAcA,KAAd;AACAvB,IAAAA,GAAG,CAACM,MAAJ,CAAWiB,KAAK,CAACE,aAAN,CAAoBC,UAA/B,EAA2CnB,IAA3C,CAAgDgB,KAAK,CAACI,OAAtD;AACA;AACD","sourcesContent":["import { query as q } from 'faunadb'\nimport { guestClient } from '@/utils/fauna-client'\nimport { setAuthCookie } from '@/utils/auth-cookies'\n\nexport default async function signup(req, res) {\n\tconst { email, username, favTeam, password } = req.body\n\n\tif (!email || !password) {\n\t\treturn res.status(400).send('Email and password not provided')\n\t}\n\n\ttry {\n\t\tconst existingEmail = await guestClient.query(\n\t\t\tq.Exists(q.Match(q.Index('user_by_email'), q.Casefold(email)))\n\t\t)\n\n\t\tif (existingEmail) {\n\t\t\treturn res.status(400).send(`Email ${email} already exists`)\n\t\t}\n\n\t\tconst user = await guestClient.query(\n\t\t\tq.Create(q.Collection('User'), {\n\t\t\t\tcredentials: { password },\n\t\t\t\tdata: { email, username, favTeam },\n\t\t\t})\n\t\t)\n\n\t\tif (!user.ref) {\n\t\t\treturn res.status(404).send('User ref is missing')\n\t\t}\n\n\t\tconst auth = await guestClient.query(\n\t\t\tq.Login(user.ref, {\n\t\t\t\tpassword,\n\t\t\t})\n\t\t)\n\n\t\tif (!auth.secret) {\n\t\t\treturn res.status(404).send('Auth secret is missing')\n\t\t}\n\n\t\tsetAuthCookie(res, auth.secret)\n\n\t\tres.status(200).end()\n\t} catch (error) {\n\t\tconsole.error(error)\n\t\tres.status(error.requestResult.statusCode).send(error.message)\n\t}\n}"]},"metadata":{},"sourceType":"module"}